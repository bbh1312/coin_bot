# 손실방지엔진 설계 (loss_hedge_engine)

## 목적
- 실 포지션 손실이 큰 구간에서 반대 방향으로 진입하여 손실을 최소화.

## 동작 개요
- `curr_position_swaggy` 엔진을 단독으로 구동.
- 실제 보유 포지션 중 손실률이 -10% 이상인 심볼만 대상.
- 대상 심볼에서 반대 방향 시그널이 발생하고 `signal.entry_ok`가 True이면 진입.
- 공통 진입 모듈은 사용하지 않음.
- 진입금액/레버리지 등은 공통 설정 값을 그대로 참조.
- 엔진 on/off는 웹/텔레그램에서 제어하되, 프로세스는 계속 실행(로직만 스킵).
- 알람은 계속 유지.

## 트리거 조건
- `signal.entry_ok == True` 만 사용.
- `signal.side`는 참고하되 포지션 방향과 일치 여부는 강제하지 않음.

## 제약 조건
- 해지 모드(양방향) 기준:
  - 이미 양방향(롱/숏 모두) 보유한 심볼은 신규 진입 금지.
  - 동일 방향 중복 진입 금지(이미 동일 방향 포지션이 있으면 스킵).
  - 한번 진입해있으면 재진입 금지(중복 진입 방지).

## 진입 금액
- 공통 모듈 설정을 그대로 사용.
- 공통 설정 로딩 로직과 동일하게 동작.

## TP/SL
- 기존 엔진 TP/SL JSON 설정값에 추가.
- 키: `loss_hedge_engine`
- 기본값:
  - TP: 3% (0.03)
  - SL: 30% (0.30)
- 이 엔진의 진입에만 해당 TP/SL 적용.
- 손실률 계산은 기존 자동 청산 기준과 동일한 로직을 사용.

## 웹/텔레그램 설정
- Web/Telegram에서 기존 엔진 설정 방식과 동일하게 추가.
- on/off 토글 키는 `loss_hedge_engine`.
- on/off 값은 `state`에 저장하여 재시작 후에도 유지.

## 알림
- 알림은 기존 유지.
- 엔진명은 항상 "손실방지엔진"으로 표기.

## 데이터/상태
- 엔진 on/off 상태는 `state`에 저장.
- 진입 중복 방지를 위한 상태 기록 필요(심볼, 방향, 진입 시각 등).
- 심볼 정규화는 기존 공통 로직 기준으로 동일하게 처리.

## 향후 구현 위치(예상)
- `engines/curr_position_swaggy/run.py`
- 웹 설정: `web_app` 내 엔진 설정 처리
- 텔레그램 설정: 기존 엔진 설정 처리 로직에 동일한 방식으로 추가

